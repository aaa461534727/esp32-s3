<!-- display.html æ¨¡å— -->
<style>
    .display-module {
        font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .display-module .container {
        max-width: 1200px;
        width: 100%;
    }
    .display-module h1 {
        font-size: 1.8rem;
        color: #1e293b;
        margin-top: 0.2rem;
        margin-bottom: 1rem;
        border-left: 6px solid #2563eb;
        padding-left: 1rem;
    }
    .display-module .controls {
        background: white;
        padding: 16px 24px;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        align-items: center;
        margin-bottom: 24px;
        backdrop-filter: blur(2px);
        border: 1px solid rgba(255,255,255,0.5);
    }
    .display-module .btn-refresh {
        background: #2563eb;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 40px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        box-shadow: 0 4px 8px rgba(37,99,235,0.3);
        border: 1px solid rgba(255,255,255,0.3);
    }
    .display-module .btn-refresh:hover {
        background: #1d4ed8;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(37,99,235,0.4);
    }
    .display-module .btn-refresh:active {
        transform: translateY(0);
    }
    .display-module .auto-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        color: #334155;
        cursor: pointer;
        background: #f1f5f9;
        padding: 6px 16px;
        border-radius: 40px;
    }
    .display-module .auto-label input {
        width: 18px;
        height: 18px;
        accent-color: #2563eb;
        margin: 0;
    }
    .display-module .update-time {
        margin-left: auto;
        color: #64748b;
        font-size: 0.9rem;
        background: #f8fafc;
        padding: 6px 16px;
        border-radius: 40px;
        border: 1px solid #e2e8f0;
    }
    .display-module .device-card {
        background: linear-gradient(145deg, #ffffff, #f9fbfe);
        border-radius: 28px;
        padding: 24px;
        margin-bottom: 28px;
        box-shadow: 0 12px 24px -8px rgba(0,34,68,0.1);
        border: 1px solid rgba(255,255,255,0.8);
        backdrop-filter: blur(4px);
    }
    .display-module .device-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #0f172a;
        margin-top: 0;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 2px dashed #cbd5e1;
        padding-bottom: 12px;
    }
    .display-module .device-title span {
        background: #2563eb15;
        padding: 6px 16px;
        border-radius: 40px;
        font-size: 0.9rem;
        color: #2563eb;
        font-weight: 400;
    }
    .display-module .fields-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* å¢åŠ æœ€å°å®½åº¦ï¼Œå®¹çº³é•¿ID */
        gap: 16px 24px;
    }
    .display-module .field-item {
        display: flex;
        align-items: baseline;
        background: #f8fafc;
        padding: 8px 16px;
        border-radius: 16px;
        border: 1px solid #e9eef3;
        transition: 0.1s;
    }
    .display-module .field-item:hover {
        background: #eef2f6;
        border-color: #b9c7da;
    }
    .display-module .field-label {
        font-weight: 600;
        color: #334155;
        min-width: 100px;
        font-size: 0.9rem;
        text-transform: capitalize;
        letter-spacing: 0.3px;
    }
    .display-module .field-value {
        color: #0f172a;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 0.95rem;
        word-break: break-word;
        margin-left: 12px;
        font-weight: 500;
    }
    /* é•¿å­—æ®µï¼ˆå¦‚IDï¼‰ä¸æ¢è¡Œï¼Œä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ */
    .display-module .field-value-long {
        white-space: nowrap;
        overflow: visible;
    }
    .display-module .field-value.null-value {
        color: #94a3b8;
        font-style: italic;
    }
    .display-module .drones-section {
        margin-top: 20px;
    }
    .display-module .drones-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 24px;
    }
    .display-module .drone-card {
        background: white;
        border-radius: 28px;
        padding: 20px;
        box-shadow: 0 10px 20px -10px rgba(0,20,40,0.12);
        border: 1px solid #eef2f6;
        transition: transform 0.15s;
        display: flex;
        flex-direction: column;
    }
    .display-module .drone-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 28px -12px #1e293b30;
    }
    .display-module .drone-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 18px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e2e8f0;
        font-weight: 600;
        color: #1e293b;
        font-size: 1.1rem;
    }
    .display-module .drone-index {
        background: #2563eb;
        color: white;
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    .display-module .drone-model {
        background: #dbeafe;
        color: #1e40af;
        padding: 4px 12px;
        border-radius: 40px;
        font-size: 0.85rem;
        margin-left: auto;
        font-weight: 400;
    }
    .display-module .drone-fields {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .display-module .drone-field-row {
        display: flex;
        align-items: baseline;
        padding: 5px 8px;
        background: #f9f9fc;
        border-radius: 14px;
        font-size: 0.9rem;
    }
    .display-module .drone-field-label {
        min-width: 110px;
        font-weight: 600;
        color: #475569;
    }
    .display-module .drone-field-value {
        color: #0f172a;
        font-family: monospace;
        word-break: break-word;
        margin-left: 30px;
        line-height: 1.5;                  /* å¢åŠ è¡Œé«˜ï¼Œæ”¹å–„å¤šè¡Œæ–‡æœ¬é—´è· */
    }
    .display-module .empty-state {
        text-align: center;
        padding: 48px 24px;
        background: white;
        border-radius: 48px;
        color: #64748b;
        font-size: 1.2rem;
        border: 2px dashed #cbd5e1;
    }
    .display-module .error-state {
        background: #fee2e2;
        border: 1px solid #f87171;
        color: #b91c1c;
        padding: 20px;
        border-radius: 40px;
        text-align: center;
    }
    .display-module .footer-note {
        text-align: right;
        color: #94a3b8;
        font-size: 0.8rem;
        margin-top: 16px;
    }
</style>

<div class="display-module">
    <div class="container">
        <h1>âœˆï¸ æ— äººæœºæ¢æµ‹æ•°æ®</h1>

        <div class="controls">
            <button class="btn-refresh" id="refreshBtn">
                <span style="font-size:1.2rem;">â†»</span> è·å–æœ€æ–°æ•°æ®
            </button>
            <label class="auto-label">
                <input type="checkbox" id="autoRefreshCheckbox"> è‡ªåŠ¨åˆ·æ–° (æ¯5ç§’)
            </label>
            <div class="update-time" id="updateTimeLabel">æœªæ›´æ–°</div>
        </div>

        <!-- æ•°æ®æ˜¾ç¤ºå®¹å™¨ -->
        <div id="dataContainer">
            <div class="empty-state">ç‚¹å‡»ã€Œè·å–æœ€æ–°æ•°æ®ã€å¼€å§‹æ˜¾ç¤º</div>
        </div>
        <div class="footer-note">* å­—æ®µä¸­æ–‡æ ‡æ³¨ï¼Œç©ºå€¼æ˜¾ç¤ºä¸ºã€Œâ€”ã€</div>
    </div>
</div>

<script>
(function() {
    // ----- å­—æ®µä¸­æ–‡æ˜ å°„ (æ ‡æ³¨) -----
    const FIELD_MAP = {
        // å…¬å…± / è®¾å¤‡å­—æ®µ
        'max_rssi': 'æœ€å¤§ä¿¡å·å¼ºåº¦',
        'listen_type': 'ç›‘å¬ç±»å‹',
        'status': 'çŠ¶æ€',
        'id': 'æ ‡è¯†ç¬¦',
        // æ— äººæœºä¸“ç”¨å­—æ®µ
        'selfid': 'è¿è¡Œæè¿°æŠ¥æ–‡å†…å®¹',
        'selfid_type': 'è¿è¡Œæè¿°æŠ¥æ–‡ç±»å‹',
        'model': 'å‹å·',
        'sn': 'åºåˆ—å·',
        'rssi': 'ä¿¡å·å¼ºåº¦',
        'channel': 'ä¿¡é“',
        'distance': 'è·ç¦»(m)',
        'air_high': 'é£è¡Œé«˜åº¦(m)',
        'high_type': 'é«˜åº¦ç±»å‹',
        'geo_high': 'åœ°ç†é«˜åº¦',
        'g_high': 'å¯¹åœ°é«˜åº¦',
        'speed': 'æ°´å¹³é€Ÿåº¦(m/s)',
        'v_speed': 'å‚ç›´é€Ÿåº¦(m/s)',
        'direction': 'èˆªå‘(Â°)',
        'lat': 'çº¬åº¦',
        'lon': 'ç»åº¦',
        'alt': 'æµ·æ‹”(m)',
        'operator_id': 'æ“ä½œå‘˜ID',
        'operator_id_type': 'æ“ä½œå‘˜IDç±»å‹',
        'operator_altitude': 'æ“ä½œå‘˜æµ·æ‹”',
        'ua_type': 'æ— äººæœºç±»å‹',
        'authtype': 'è‡ªå®šä¹‰æŠ¥æ–‡ç±»å‹',
        'authentication_data': 'è‡ªå®šä¹‰æŠ¥æ–‡å†…å®¹',
        'timestamp': 'æ—¶é—´æˆ³',
        'channel_busy_time': 'ä¿¡é“å ç”¨æ—¶é—´',
        'ilotLon': 'æ“ä½œå‘˜ç»åº¦',
        'ilotLat': 'æ“ä½œå‘˜çº¬åº¦',
        'time_acc': 'æ—¶é—´ç²¾åº¦',
        // è®¾å¤‡çŠ¶æ€
        'status': 'çŠ¶æ€',
        // é¢å¤–çš„å­—æ®µä»¥é˜²é—æ¼
        'id': 'ID',
        'basic_id': 'åŸºç¡€ID',
        'custom_desc': 'è‡ªå®šä¹‰æè¿°',
        'run_desc': 'è¿è¡Œæè¿°',
        'operator_info': 'æ“ä½œå‘˜ä¿¡æ¯',
    };

    // é€šç”¨å­—æ®µå€¼æ ¼å¼åŒ– (å¯æ‰©å±•)
    function formatValue(val) {
        if (val === undefined || val === null) return 'â€”';
        if (typeof val === 'boolean') return val ? 'æ˜¯' : 'å¦';
        if (typeof val === 'number') return val;
        if (typeof val === 'string' && val.trim() === '') return 'â€”';
        return val;
    }

    // è·å–ä¸­æ–‡æ ‡ç­¾
    function getLabel(key) {
        return FIELD_MAP[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // æ¸²æŸ“è®¾å¤‡ä¿¡æ¯ (å•ä¸ªå¯¹è±¡)ï¼Œç‰¹æ®Šå¤„ç† listen_type å’Œ status
    function renderDeviceObject(deviceData, title) {
        if (!deviceData || typeof deviceData !== 'object' || Object.keys(deviceData).length === 0) {
            return `<div class="device-card">${title} <span>æ— æ•°æ®</span></div>`;
        }

        let fieldsHtml = '';
        for (const [key, value] of Object.entries(deviceData)) {
            let displayValue;
            const label = getLabel(key);
            
            // ç‰¹æ®Šå­—æ®µå¤„ç†
            if (key === 'listen_type') {
                if (value === 0) displayValue = 'æ— çº¿WiFi';
                else if (value === 1) displayValue = 'è“ç‰™BLE';
                else displayValue = formatValue(value);
            } else if (key === 'status') {
                if (value === true) displayValue = 'å¼€å¯';
                else if (value === false) displayValue = 'å…³é—­';
                else displayValue = formatValue(value);
            } else {
                displayValue = formatValue(value);
            }

            // ä¸º id å­—æ®µæ·»åŠ ç‰¹æ®Šç±»ï¼Œä½¿å…¶ä¸æ¢è¡Œ
            const valueClass = (key === 'id') ? 'field-value field-value-long' : 'field-value';

            fieldsHtml += `
                <div class="field-item">
                    <span class="field-label">${label}</span>
                    <span class="${valueClass} ${displayValue === 'â€”' ? 'null-value' : ''}">${displayValue}</span>
                </div>
            `;
        }

        return `
            <div class="device-card">
                <div class="device-title">
                    ğŸ“¡ ${title}
                    <span>æ¥æ”¶ç«¯</span>
                </div>
                <div class="fields-grid">
                    ${fieldsHtml}
                </div>
            </div>
        `;
    }

    // æ¸²æŸ“æ— äººæœºæ•°ç»„ï¼ˆç§»é™¤äº† selfid æ˜¾ç¤ºï¼‰
    function renderDronesArray(drones) {
        if (!Array.isArray(drones) || drones.length === 0) {
            return '<div class="empty-state" style="margin-top:20px;">ğŸš æ²¡æœ‰æ¢æµ‹åˆ°æ— äººæœº</div>';
        }

        let dronesHtml = '';
        drones.forEach((drone, idx) => {
            // æå–å…³é”®ä¿¡æ¯ç”¨äºå¤´éƒ¨æ˜¾ç¤º (å‹å·)
            const model = drone.model || 'æœªçŸ¥å‹å·';
            
            let fieldsRows = '';
            // éå†æ‰€æœ‰å­—æ®µ
            for (const [key, value] of Object.entries(drone)) {
                const label = getLabel(key);
                const displayValue = formatValue(value);
                fieldsRows += `
                    <div class="drone-field-row">
                        <span class="drone-field-label">${label}</span>
                        <span class="drone-field-value ${displayValue === 'â€”' ? 'null-value' : ''}">${displayValue}</span>
                    </div>
                `;
            }

            dronesHtml += `
                <div class="drone-card">
                    <div class="drone-header">
                        <span class="drone-index">${idx+1}</span>
                        <span class="drone-model" style="margin-left:0;">${model}</span>
                    </div>
                    <div class="drone-fields">
                        ${fieldsRows}
                    </div>
                </div>
            `;
        });

        return `<div class="drones-grid">${dronesHtml}</div>`;
    }

    // ----- æ ¸å¿ƒè·å–&æ¸²æŸ“é€»è¾‘ -----
    const dataContainer = document.getElementById('dataContainer');
    const refreshBtn = document.getElementById('refreshBtn');
    const autoCheck = document.getElementById('autoRefreshCheckbox');
    const updateTimeLabel = document.getElementById('updateTimeLabel');

    let autoTimer = null;
    let lastFetchTime = null;

    // æ¸…é™¤æ—§å®šæ—¶å™¨ (ä½¿ç”¨å…¨å±€æ ‡è¯†é˜²æ­¢å¤šä¸ªå®ä¾‹)
    if (window._displayModuleTimer) {
        clearInterval(window._displayModuleTimer);
        window._displayModuleTimer = null;
    }

    // æ¸…é™¤å½“å‰æ¨¡å—çš„å®šæ—¶å™¨
    function clearAutoTimer() {
        if (autoTimer) {
            clearInterval(autoTimer);
            autoTimer = null;
        }
    }

    // å¯åŠ¨è‡ªåŠ¨åˆ·æ–° (å¦‚æœå¤é€‰æ¡†é€‰ä¸­)
    function startAutoRefreshIfNeeded() {
        clearAutoTimer(); // æ€»æ˜¯å…ˆæ¸…é™¤
        if (autoCheck.checked) {
            autoTimer = setInterval(() => {
                fetchData();
            }, 5000); // 5ç§’
            window._displayModuleTimer = autoTimer; // è®°å½•åˆ°å…¨å±€ä»¥ä¾¿åˆ‡æ¢æ—¶æ¸…ç†
        } else {
            window._displayModuleTimer = null;
        }
    }

    // æ›´æ–°é¡µé¢æ—¶é—´æ˜¾ç¤º
    function updateTimestamp() {
        if (lastFetchTime) {
            const date = new Date(lastFetchTime);
            updateTimeLabel.textContent = `æœ€åæ›´æ–°: ${date.toLocaleTimeString()}.${date.getMilliseconds()}`;
        } else {
            updateTimeLabel.textContent = 'æœªæ›´æ–°';
        }
    }

    // æ¸²æŸ“æ•°æ®åˆ°å®¹å™¨
    function renderData(jsonData) {
        if (!jsonData || typeof jsonData !== 'object') {
            dataContainer.innerHTML = `<div class="error-state">âŒ æ— æ•ˆçš„æ•°æ®æ ¼å¼</div>`;
            return;
        }

        let html = '';

        // 1. æ¸²æŸ“ devices éƒ¨åˆ† (å¦‚æœå­˜åœ¨)
        if (jsonData.devices) {
            html += renderDeviceObject(jsonData.devices, 'æ¥æ”¶è®¾å¤‡ä¿¡æ¯');
        } else {
            html += `<div class="device-card">ğŸ“¡ æ¥æ”¶è®¾å¤‡ä¿¡æ¯ <span>å­—æ®µç¼ºå¤±</span></div>`;
        }

        // 2. æ¸²æŸ“ drones éƒ¨åˆ†
        html += `<div class="drones-section"><h2 style="margin: 12px 0 12px 8px; font-size:1.3rem;">ğŸ›¸ æ— äººæœºåˆ—è¡¨ (${Array.isArray(jsonData.drones) ? jsonData.drones.length : 0})</h2>`;
        html += renderDronesArray(jsonData.drones);
        html += `</div>`;

        dataContainer.innerHTML = html;
    }

    // è·å–æ•°æ®
    function fetchData() {
        fetch('/data')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.text(); // å…ˆç”¨æ–‡æœ¬ï¼Œå°è¯•è§£æJSON
            })
            .then(text => {
                // å°è¯•è§£æJSON
                let parsed;
                try {
                    parsed = JSON.parse(text);
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬ä½†ç»™å‡ºæç¤º
                    dataContainer.innerHTML = `<div class="error-state">âŒ è¿”å›æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSON: <pre style="background:#1e293b;color:#ddd;padding:12px;border-radius:16px;overflow:auto;">${text.substring(0,200)}${text.length>200?'...':''}</pre></div>`;
                    return;
                }
                lastFetchTime = Date.now();
                updateTimestamp();
                renderData(parsed);
            })
            .catch(err => {
                console.error('è·å–å¤±è´¥:', err);
                dataContainer.innerHTML = `<div class="error-state">âŒ è·å–æ•°æ®å¤±è´¥: ${err.message}</div>`;
                lastFetchTime = null;
                updateTimestamp();
            });
    }

    // äº‹ä»¶ç»‘å®š
    refreshBtn.addEventListener('click', () => {
        fetchData();
    });

    autoCheck.addEventListener('change', () => {
        startAutoRefreshIfNeeded();
    });

    // é¡µé¢å¸è½½æˆ–æ¨¡å—è¢«æ›¿æ¢æ—¶æ¸…ç†å®šæ—¶å™¨ï¼ˆé€šè¿‡å…¨å±€æ ‡è¯†ï¼‰
    window.addEventListener('beforeunload', function() {
        clearAutoTimer();
    });

    // è‡ªåŠ¨è·å–æœ€æ–°æ•°æ®ï¼ˆè¿›å…¥æ¨¡å—å³æ˜¾ç¤ºï¼‰
    fetchData(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ•°æ®è·å–
})();
</script>